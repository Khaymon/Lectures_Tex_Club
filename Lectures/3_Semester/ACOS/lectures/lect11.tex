\section{Процессы}

\subsection{Что такое процесс?}

\begin{Def}
	\underline{Процесс} --- это экземпляр программы в одном из состояний выполнения. Каждый
	из процессов выполняется в своем изолированном адресном пространстве.
\end{Def}

\subsection{Аттрибуты процесса}

Память:
\begin{itemize}
	\item Значения регистров процессора.
	\item Таблицы и каталоги страниц виртуального адресного пространства.
	\item Private и Shared страницы памяти.
	\item Отображение файлов в память.
	\item Отдельный стек в ядре для обработки системных вызовов.
\end{itemize}

Файловая система:
\begin{itemize}
	\item Таблица файловых дескрипторов.
	\item Текущий каталог.
	\item Корневой каталог.
	\item Маска аттрибутов создания нового файла umask. 
\end{itemize}

Другие аттрибуты:
\begin{itemize}
	\item Переменные окружения
	\item Лимиты
	\item Счетчики ресурсов
	\item Идентификаторы пользователя и группы
\end{itemize}

\subsection{Информация о процессах}

Команда \textbf{ps} показывает список процессов, \textbf{top} --- потребление ресурсов.

\subsection{Жизненный цикл процессов}

\begin{itemize}
	\item Выполняется (Running)
	\item Остановлен (Stopped)
	\item Временно приостановлен
		\begin{itemize}
			\item Suspended --- может быть завершен
			\item Disk Suspended --- не может быть завершен
		\end{itemize}
	\item Исследуется (Tracing)
	\item Зомби (Zombie)
\end{itemize}

\textbf{Как устроен планировщик заданий?}

\subsection{Round Robin}
\textit{Windows 9x, старые UNIX}

Аппаратный таймер время от времени генерирует прерывание, после чего планировщик
выбирает, какой процесс будет выполняться дальше.

\subsection{Приоритет}

\begin{itemize}
	\item Значение от -20 до 19
	\item Численное значение --- сколько раз пропустить планировщиком заданий
\end{itemize}

\subsection{Многоуровневая очередь}
\textit{Linux, xBSD, Mac, Windows}

Эта схема отталкивается от того, что есть два типа процессов:
\begin{itemize}
	\item Не очень активно взаимодействующие с внешним миром (что-то вычисляют). 
	Им надо просто не мешать выполняться. 
	\item Много взаимодействующие с пользователем. Их надо переключать быстро.
\end{itemize}

Есть набор очередей, уровней, которые рассположены по увеличению времени переключения.
При переключении очереди, если процесс освободил процессор до следующего события, он
перемещается в следующую очередь (более редко переключаемую), иначе --- в предыдущую.

\subsection{Ничегонеделание}

while (1) {
	// Так делать очень плохо, потому что вы загружаете процессор
}

while (1) {
	sched\_yield(); // Передаем управление другому процессу
}

\subsection{Создание процесса}

Системный вызов fork().
Было на семах. 
\textit{Узнать больше: man fork}

\subsection{Копия процесса}

При fork создается полная копия процесса. Память, регистры, ... --- точная копия.

Не копируются:
\begin{itemize}
	\item eax, rax
	\item Сигналы, ожидающие доставки
	\item Таймеры
	\item Блокировки файлов
\end{itemize}

\textbf{В связи с копированием всего адресного пространства может возникать необычное поведение.} Например, 
буфер ввода и вывода тоже копируется. Поэтому если не сделать fflush, один и тот
же текст может продублироваться.

\subsection{Ограничения}

/proc/sys/kernel/pid\_max --- максимальное число одновременно запущенных процессов.
/proc/sys/kernel/threads\_max --- максимальное число одновременно 
выполняющихся потоков (каждый процесс --- уже один поток).

\subsection{Дерево процессов}

\begin{itemize}
	\item Процесс с номером 1 --- systemd
	\item У каждого процесса кроме systemd есть свой родитель
	\item Если родитель процесса умирает, то его родителем становится systemd.
	\item Если ребенок умирает, про это узнает его родитель. 
\end{itemize}

\subsection{Завершение работы процесса}

\begin{itemize}
	\item Системный вызов \_exit(int)
	\item Функция exit(int)
	\item Оператор return в main
\end{itemize}

\subsection{Ожидание завершения процесса}

Системный вызов waitpid.

\subsection{Zombie процессы}

Удалением зомби из таблицы процессов занимается родитель --- 
вызовом wait или waitpid.

\subsection{exec}

Системный вызом exec позволяет заместить тело процесса другой программой.
\textit{Было на семах.}

\subsection{Аттрибуты процесса, сохраняемые exec}

\begin{itemize}
	\item Открытые файловые дескрипторы 
	\item Текущий каталог
	\item Лимиты процесса
	\item UID, GID
	\item Корневой каталог --- root.
\end{itemize}

\subsection{SUID-флаг}

Это довольнительный аттрибут выполняемого файла. Он означается, что файл запускается от
имени того пользователя, который является владельцем файла. 

\subsection{setuid/getuid vs geteuid}

\begin{Def}
	\underline{Реальный user id} --- тот пользователь, который действительно запускает текущий процесс. Например, запуская с помощью sudo все равно можно узнать, кто именно запустил.
\end{Def}

\begin{Def}
	\underline{Эффективный user id} --- определяет то, с какими правами процесс исполняется.
\end{Def}

\subsection{Лимиты}

Например, перед запуском процесса можно проставить лимиты. 

Лимитировать можно:

\begin{itemize}
	\item Обьемы памяти:
		\begin{itemize}
			\item Адресное пространство
			\item Стек
			\item RSS
		\end{itemize}
	\item Открытые файлы
	\item Количество процессов
	\item Процессорное время работы процесса
\end{itemize}
